<!DOCTYPE html>
<html lang="vi" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LingoPro Ultra - Secure Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #6366f1; --secondary: #ec4899; --bg-dark: #0f172a; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-dark); color: #f8fafc; overflow: hidden; height: 100vh; }
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 24px; }
        .source-word { display: inline-block; cursor: pointer; padding: 0 4px; border-radius: 6px; transition: all 0.15s ease; font-weight: 500; }
        .source-word:hover { background: var(--primary); color: white; transform: translateY(-2px); }
        .lyric-line { padding: 10px 16px; border-radius: 12px; border-left: 4px solid transparent; transition: all 0.2s; }
        .lyric-line:hover { background: rgba(255, 255, 255, 0.05); border-left-color: var(--primary); }
        #translation-popup { position: fixed; bottom: -300px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 450px; z-index: 1000; }
        .auth-overlay { position: fixed; inset: 0; background: rgba(7, 10, 19, 0.95); backdrop-filter: blur(12px); z-index: 3000; display: none; align-items: center; justify-content: center; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="antialiased">

    <div id="loader" class="fixed inset-0 z-[9999] bg-slate-950 flex items-center justify-center">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-indigo-400 font-black tracking-widest animate-pulse">LINGOPRO SECURE BOOTING...</p>
        </div>
    </div>

    <nav class="h-20 border-b border-slate-800/60 px-8 flex items-center justify-between bg-slate-950/50 backdrop-blur-xl sticky top-0 z-50">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center shadow-lg"><i class="fa-solid fa-shield-halved text-white"></i></div>
            <span class="text-xl font-black tracking-tighter uppercase">Lingo<span class="text-indigo-500">Pro</span></span>
        </div>

        <div class="flex items-center gap-4 bg-slate-900/80 p-1 rounded-2xl border border-slate-800">
            <div id="auth-controls" class="flex gap-2">
                <button onclick="toggleAuth('login')" class="px-5 py-2 rounded-xl text-sm font-bold hover:bg-slate-800 transition">Đăng nhập</button>
                <button onclick="toggleAuth('signup')" class="px-5 py-2 bg-indigo-600 rounded-xl text-sm font-bold hover:bg-indigo-500 transition">Khởi tạo ID</button>
            </div>
            <div id="user-display" class="hidden flex items-center gap-3 px-4">
                <span id="username-tag" class="text-sm font-black text-indigo-400"></span>
                <button onclick="logout()" class="text-xs text-red-400 font-bold border-l border-slate-700 pl-3">THOÁT</button>
            </div>
        </div>
        
        <div class="flex gap-3">
            <button onclick="toggleDashboard()" class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center hover:text-indigo-400 transition"><i class="fa-solid fa-chart-simple"></i></button>
            <button onclick="openQuiz()" class="bg-indigo-600 px-6 py-2 rounded-full font-black text-xs hover:scale-105 transition">TEST SKILLS</button>
        </div>
    </nav>

    <div id="auth-overlay" class="auth-overlay">
        <div class="glass-card p-10 w-full max-w-md border-t-8 border-indigo-500 shadow-2xl">
            <div id="login-section">
                <h2 class="text-3xl font-black mb-2 italic">HỆ THỐNG AN NINH</h2>
                <p class="text-xs text-slate-500 mb-8 font-bold uppercase tracking-widest">Vui lòng xác thực danh tính</p>
                <input type="text" id="l-user" placeholder="Username" class="w-full px-5 py-4 rounded-2xl mb-4 bg-slate-900 border border-slate-800 focus:border-indigo-500 outline-none transition">
                <input type="password" id="l-pass" placeholder="Password" class="w-full px-5 py-4 rounded-2xl mb-6 bg-slate-900 border border-slate-800 focus:border-indigo-500 outline-none transition">
                <button onclick="handleLogin()" class="w-full bg-indigo-600 py-4 rounded-2xl font-black text-lg shadow-xl hover:bg-indigo-500 transition">ĐĂNG NHẬP</button>
                <p class="text-center text-xs mt-6">Chưa có ID? <button onclick="toggleAuth('signup')" class="text-indigo-400 font-bold underline">Đăng ký mới</button></p>
            </div>
            <div id="signup-section" class="hidden">
                <h2 class="text-3xl font-black mb-2 italic text-pink-500">TẠO TÀI KHOẢN</h2>
                <p class="text-xs text-slate-500 mb-8 font-bold uppercase tracking-widest">Mật khẩu sẽ được mã hóa SHA-256</p>
                <input type="text" id="s-user" placeholder="Username" class="w-full px-5 py-4 rounded-2xl mb-4 bg-slate-900 border border-slate-800 focus:border-pink-500 outline-none transition">
                <input type="password" id="s-pass" placeholder="Password" class="w-full px-5 py-4 rounded-2xl mb-6 bg-slate-900 border border-slate-800 focus:border-pink-500 outline-none transition">
                <button onclick="handleSignup()" class="w-full bg-pink-600 py-4 rounded-2xl font-black text-lg shadow-xl hover:bg-pink-500 transition">XÁC NHẬN ĐĂNG KÝ</button>
                <p class="text-center text-xs mt-6">Đã có ID? <button onclick="toggleAuth('login')" class="text-pink-400 font-bold underline">Quay lại</button></p>
            </div>
            <button onclick="closeAuth()" class="w-full text-[10px] font-black text-slate-600 mt-8 tracking-widest hover:text-white transition">HỦY BỎ</button>
        </div>
    </div>

    <main class="flex h-[calc(100vh-80px)]">
        <aside class="w-[400px] border-r border-slate-800/60 p-8 space-y-8 bg-slate-950/20 overflow-y-auto">
            <section>
                <h3 class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4">Media Source</h3>
                <div class="glass-card p-4 space-y-3">
                    <div id="player" class="aspect-video bg-black rounded-xl overflow-hidden shadow-inner"></div>
                    <input type="text" id="yt-url" placeholder="Paste YouTube Link..." class="w-full px-4 py-3 bg-slate-900 border border-slate-800 rounded-xl text-sm outline-none focus:border-indigo-500 transition">
                </div>
            </section>
            <section>
                <h3 class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4">Input Data</h3>
                <div class="glass-card p-4 space-y-3">
                    <textarea id="lyric-input" rows="10" placeholder="Nhập lời bài hát..." class="w-full p-4 bg-slate-900 border border-slate-800 rounded-xl text-sm outline-none resize-none focus:border-indigo-500 transition"></textarea>
                    <button id="process-btn" class="w-full bg-gradient-to-r from-indigo-600 to-indigo-800 py-4 rounded-xl font-black uppercase text-xs shadow-lg hover:scale-[1.02] transition">Compile Study Session</button>
                </div>
            </section>
        </aside>

        <section class="flex-1 flex flex-col bg-slate-950/40">
            <div class="px-10 py-5 border-b border-slate-800/60 flex justify-between items-center">
                <h2 class="font-black text-xl uppercase tracking-tighter">Interactive Classroom</h2>
                <select id="target-lang" class="bg-slate-800 border-none rounded-full px-4 py-1.5 text-xs font-black">
                    <option value="vi">TIẾNG VIỆT</option>
                    <option value="en">ENGLISH</option>
                    <option value="ko">KOREAN</option>
                </select>
            </div>
            <div id="lyric-display" class="flex-1 overflow-y-auto px-16 py-12 space-y-3 text-lg">
                <div class="text-center opacity-20 mt-20">
                    <i class="fa-solid fa-brain text-8xl mb-6"></i>
                    <p class="font-black uppercase">Chưa có dữ liệu phiên học</p>
                </div>
            </div>
        </section>

        <aside class="w-[350px] border-l border-slate-800/60 p-6 hidden xl:block overflow-y-auto">
            <h3 class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-6">Saved Vocabulary</h3>
            <div id="notebook-list" class="space-y-3"></div>
        </aside>
    </main>

    <div id="translation-popup" class="glass-card p-8 border-t-8 border-indigo-500 shadow-2xl">
        <div class="flex justify-between items-start">
            <div>
                <p id="pop-src" class="text-sm font-black text-indigo-400 uppercase tracking-widest mb-2"></p>
                <h2 id="pop-vi" class="text-4xl font-black"></h2>
            </div>
            <div class="flex flex-col gap-2">
                <button onclick="speak()" class="w-12 h-12 rounded-xl bg-slate-800 hover:bg-indigo-600 transition flex items-center justify-center"><i class="fa-solid fa-volume-high"></i></button>
                <button onclick="saveVocab()" class="w-12 h-12 rounded-xl bg-slate-800 hover:bg-pink-600 transition flex items-center justify-center"><i class="fa-solid fa-bookmark"></i></button>
            </div>
        </div>
        <button onclick="closePopup()" class="mt-6 text-[10px] font-black text-slate-500 uppercase hover:text-white transition">Đóng cửa sổ</button>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        const state = {
            user: JSON.parse(localStorage.getItem('lingopro_active')) || null,
            notebook: [],
            current: { src: '', vi: '' }
        };

        // --- HỆ THỐNG MÃ HÓA & AUTH ---
        function toggleAuth(type) {
            document.getElementById('auth-overlay').style.display = 'flex';
            document.getElementById('login-section').classList.toggle('hidden', type !== 'login');
            document.getElementById('signup-section').classList.toggle('hidden', type !== 'signup');
        }

        function closeAuth() { document.getElementById('auth-overlay').style.display = 'none'; }

        // Đăng ký với mã hóa SHA-256
        function handleSignup() {
            const u = document.getElementById('s-user').value, p = document.getElementById('s-pass').value;
            if(!u || p.length < 6) return alert("Username không được để trống và Pass >= 6 ký tự!");

            const db = JSON.parse(localStorage.getItem('lingopro_users_db') || '[]');
            if(db.some(x => x.username === u)) return alert("Tên tài khoản này đã có người sử dụng!");

            // MÃ HÓA MẬT KHẨU TRƯỚC KHI LƯU
            const hashedPassword = CryptoJS.SHA256(p).toString();
            
            db.push({ username: u, password: hashedPassword, vocab: [] });
            localStorage.setItem('lingopro_users_db', JSON.stringify(db));
            
            alert("Đăng ký thành công! Mật khẩu của bạn đã được mã hóa an toàn.");
            toggleAuth('login');
        }

        // Đăng nhập với so khớp mã hóa
        function handleLogin() {
            const u = document.getElementById('l-user').value, p = document.getElementById('l-pass').value;
            const db = JSON.parse(localStorage.getItem('lingopro_users_db') || '[]');
            
            // Mã hóa mật khẩu vừa nhập để so sánh với bản lưu trong DB
            const hashedInput = CryptoJS.SHA256(p).toString();
            const user = db.find(x => x.username === u && x.password === hashedInput);

            if(user) {
                state.user = { username: user.username };
                localStorage.setItem('lingopro_active', JSON.stringify(state.user));
                location.reload();
            } else {
                alert("Sai thông tin đăng nhập! Hệ thống từ chối truy cập.");
            }
        }

        function logout() {
            localStorage.removeItem('lingopro_active');
            location.reload();
        }

        // --- CORE LOGIC ---
        function initApp() {
            if(state.user) {
                document.getElementById('auth-controls').classList.add('hidden');
                document.getElementById('user-display').classList.remove('hidden');
                document.getElementById('username-tag').innerText = state.user.username;
                
                const db = JSON.parse(localStorage.getItem('lingopro_users_db') || '[]');
                const found = db.find(x => x.username === state.user.username);
                state.notebook = found ? found.vocab : [];
                renderNotebook();
            }
            setTimeout(() => gsap.to('#loader', { opacity: 0, pointerEvents: 'none' }), 1000);
        }

        document.getElementById('process-btn').onclick = () => {
            const text = document.getElementById('lyric-input').value.trim();
            const yt = document.getElementById('yt-url').value;
            if(!text) return;

            const vid = yt.match(/(?:v=|\/)([0-9A-Za-z_-]{11})/);
            if(vid) {
                if(window.ytPlayer) window.ytPlayer.loadVideoById(vid[1]);
                else window.ytPlayer = new YT.Player('player', { videoId: vid[1] });
            }
            renderLyrics(text);
        };

        function renderLyrics(text) {
            const container = document.getElementById('lyric-display');
            container.innerHTML = "";
            text.split('\n').forEach(line => {
                if(!line.trim()) return;
                const div = document.createElement('div');
                div.className = "lyric-line";
                line.split(/\s+/).forEach(word => {
                    const span = document.createElement('span');
                    span.className = "source-word";
                    span.innerText = word + " ";
                    span.onclick = () => translate(word.replace(/[.,!?;:]/g, ""));
                    div.appendChild(span);
                });
                container.appendChild(div);
            });
            gsap.from('.lyric-line', { opacity: 0, y: 10, stagger: 0.05 });
        }

        async function translate(word) {
            const target = document.getElementById('target-lang').value;
            document.getElementById('pop-src').innerText = word;
            document.getElementById('pop-vi').innerText = "...";
            gsap.to('#translation-popup', { bottom: 30, duration: 0.5, ease: "back.out" });

            try {
                const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${target}&dt=t&q=${word}`);
                const data = await res.json();
                state.current = { src: word, vi: data[0][0][0] };
                document.getElementById('pop-vi').innerText = state.current.vi;
            } catch { document.getElementById('pop-vi').innerText = "Lỗi kết nối"; }
        }

        function saveVocab() {
            if(!state.user) return toggleAuth('login');
            if(state.notebook.some(x => x.src === state.current.src)) return;

            state.notebook.unshift({...state.current});
            const db = JSON.parse(localStorage.getItem('lingopro_users_db') || '[]');
            const idx = db.findIndex(x => x.username === state.user.username);
            db[idx].vocab = state.notebook;
            localStorage.setItem('lingopro_users_db', JSON.stringify(db));
            renderNotebook();
        }

        function renderNotebook() {
            const list = document.getElementById('notebook-list');
            list.innerHTML = state.notebook.map((item, i) => `
                <div class="glass-card p-4 flex justify-between items-center group">
                    <div>
                        <p class="text-indigo-400 font-black text-xs uppercase">${item.src}</p>
                        <p class="text-sm font-bold">${item.vi}</p>
                    </div>
                    <button onclick="removeVocab(${i})" class="text-slate-700 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-trash"></i></button>
                </div>
            `).join('');
        }

        function removeVocab(i) {
            state.notebook.splice(i, 1);
            const db = JSON.parse(localStorage.getItem('lingopro_users_db') || '[]');
            const idx = db.findIndex(x => x.username === state.user.username);
            db[idx].vocab = state.notebook;
            localStorage.setItem('lingopro_users_db', JSON.stringify(db));
            renderNotebook();
        }

        function closePopup() { gsap.to('#translation-popup', { bottom: -400 }); }
        function speak() { window.speechSynthesis.speak(new SpeechSynthesisUtterance(state.current.src)); }

        initApp();
    </script>
</body>
</html>
