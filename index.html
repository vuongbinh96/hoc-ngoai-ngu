<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LingoPro Turbo - Instant Translation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { background: #0f172a; font-family: 'Inter', sans-serif; color: white; height: 100vh; overflow: hidden; }
        
        /* Dropdown Ng√¥n ng·ªØ - Ch·ªØ ƒëen chu·∫©n 100% */
        #tts-lang {
            background-color: white !important;
            color: black !important;
            border: none; padding: 5px 15px; border-radius: 10px; font-weight: bold; cursor: pointer;
        }
        #tts-lang option { color: black; background: white; }

        .lyric-card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .source-word { 
            font-size: 1.3rem; font-weight: 700; color: #1e293b; 
            cursor: pointer; padding: 2px 2px; border-radius: 4px; transition: 0.1s;
        }
        .source-word:hover { background: #fee2e2; color: #ef4444; }
        
        /* Popup m∆∞·ª£t m√† */
        #translate-popup {
            position: fixed; bottom: -200px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background: white; color: #1e293b; padding: 20px;
            border-radius: 25px; display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.4); transition: 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); 
            z-index: 1000; border: 3px solid #ef4444;
        }
        #translate-popup.active { bottom: 20px; }

        /* Loading Bar cho vi·ªác d·ªãch tr∆∞·ªõc */
        #pre-load-status { display: none; background: #ef4444; height: 4px; position: fixed; top: 0; left: 0; z-index: 9999; transition: width 0.3s; }
    </style>
</head>
<body class="p-4 md:p-6">

    <div id="pre-load-status"></div>

    <header class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-black italic tracking-tighter">LINGO<span class="text-red-500">PRO</span></h1>
        <div class="flex items-center gap-3">
            <select id="tts-lang">
                <option value="en-US">ENGLISH</option>
                <option value="ko-KR">KOREAN</option>
                <option value="ja-JP">JAPANESE</option>
                <option value="fr-FR">FRENCH</option>
            </select>
            <button onclick="openQuiz()" class="bg-red-500 text-white px-5 py-2 rounded-full font-black text-xs">THI</button>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        <div class="lg:col-span-4 space-y-4">
            <div id="player-container" class="rounded-2xl overflow-hidden aspect-video bg-black">
                <div id="player"></div>
            </div>
            <textarea id="lyric-input" rows="6" class="w-full p-4 rounded-xl bg-slate-800 border border-slate-700 text-sm outline-none focus:border-red-500" placeholder="D√°n Lyrics v√†o ƒë√¢y..."></textarea>
            <button id="btn-nap" onclick="initApp()" class="w-full bg-blue-600 py-4 rounded-xl font-black uppercase hover:bg-blue-500 transition">üöÄ N·∫°p & D·ªãch Si√™u T·ªëc</button>
        </div>

        <div class="lg:col-span-8">
            <div id="lyric-display" class="h-[70vh] overflow-y-auto pr-2">
                <div class="h-full flex flex-col items-center justify-center opacity-20 text-center">
                    <i class="fa-solid fa-bolt text-6xl mb-4"></i>
                    <p class="font-bold">H·ªá th·ªëng s·∫µn s√†ng!<br>N·∫°p lyrics ƒë·ªÉ tr·∫£i nghi·ªám d·ªãch t·ª©c th√¨.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="translate-popup">
        <div>
            <p id="pop-src" class="text-[10px] font-black text-slate-400 uppercase tracking-widest">WORD</p>
            <p id="pop-vi" class="text-2xl font-black text-red-600 leading-tight">...</p>
        </div>
        <button onclick="speakWord()" class="w-12 h-12 bg-red-500 text-white rounded-full shadow-lg active:scale-90 transition">
            <i class="fa-solid fa-volume-high"></i>
        </button>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        let dictionary = {}; // N∆°i l∆∞u tr·ªØ to√†n b·ªô t·ª´ ƒë√£ d·ªãch s·∫µn
        let player, popupTimer;

        // H√†m d·ªãch h√†ng lo·∫°t (Batch Translation) - ƒê√¢y l√† b√≠ k√≠p t·ªëc ƒë·ªô
        async function preTranslateAll(words) {
            const status = document.getElementById('pre-load-status');
            status.style.display = 'block';
            status.style.width = '10%';

            // Chia nh·ªè danh s√°ch t·ª´ ƒë·ªÉ tr√°nh qu√° t·∫£i (m·ªói l·∫ßn d·ªãch 30 t·ª´)
            const batchSize = 30;
            for (let i = 0; i < words.length; i += batchSize) {
                const batch = words.slice(i, i + batchSize);
                const query = batch.join(" | "); // D√πng k√Ω t·ª± ƒë·∫∑c bi·ªát ƒë·ªÉ t√°ch
                
                try {
                    const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=vi&dt=t&q=${encodeURIComponent(query)}`);
                    const data = await res.json();
                    const translatedText = data[0][0][0];
                    const translatedBatch = translatedText.split(" | ");
                    
                    batch.forEach((word, index) => {
                        dictionary[word.toLowerCase()] = translatedBatch[index]?.trim() || "...";
                    });
                } catch (e) { console.error("L·ªói d·ªãch m·∫£ng"); }
                
                status.style.width = `${((i + batchSize) / words.length) * 100}%`;
            }
            
            setTimeout(() => status.style.display = 'none', 500);
        }

        function initApp() {
            const text = document.getElementById('lyric-input').value.trim();
            if(!text) return alert("D√°n l·ªùi b√†i h√°t ƒë√£ b·∫°n ∆°i!");

            // 1. L·∫•y t·∫•t c·∫£ t·ª´ duy nh·∫•t
            const allWords = Array.from(new Set(text.match(/\b\w+\b/g))).filter(w => w.length > 1);
            
            // 2. Ch·∫°y d·ªãch ng·∫ßm to√†n b·ªô
            dictionary = {};
            preTranslateAll(allWords);

            // 3. Hi·ªÉn th·ªã Lyrics
            render(text);
        }

        function render(text) {
            const container = document.getElementById('lyric-display');
            container.innerHTML = "";
            
            text.split('\n').filter(l => l.trim()).forEach(line => {
                const card = document.createElement('div');
                card.className = 'lyric-card';
                const wordsWrap = document.createElement('div');
                
                // T√°ch ch·ªØ v√† gi·ªØ nguy√™n ƒë·ªãnh d·∫°ng
                line.split(/(\s+)/).forEach(token => {
                    if(/\s+/.test(token)) {
                        wordsWrap.appendChild(document.createTextNode(token));
                    } else {
                        const span = document.createElement('span');
                        span.className = 'source-word';
                        span.innerText = token;
                        
                        const cleanWord = token.replace(/[.,!?;:'"‚Äú‚Äù]/g, "").toLowerCase();
                        
                        // KHI B·∫§M: L·∫•y ngay trong dictionary, kh√¥ng ƒë·ª£i API n·ªØa
                        span.onclick = () => {
                            const result = dictionary[cleanWord] || "ƒêang x·ª≠ l√Ω...";
                            showPop(token, result);
                        };
                        wordsWrap.appendChild(span);
                    }
                });
                card.appendChild(wordsWrap);
                container.appendChild(card);
            });
        }

        function showPop(src, vi) {
            const pop = document.getElementById('translate-popup');
            document.getElementById('pop-src').innerText = src;
            document.getElementById('pop-vi').innerText = vi;
            pop.classList.add('active');
            
            if(popupTimer) clearTimeout(popupTimer);
            popupTimer = setTimeout(() => pop.classList.remove('active'), 5000);
        }

        function speakWord() {
            const t = document.getElementById('pop-src').innerText;
            const u = new SpeechSynthesisUtterance(t);
            u.lang = /[\uAC00-\uD7A3]/.test(t) ? 'ko-KR' : document.getElementById('tts-lang').value;
            window.speechSynthesis.speak(u);
        }

        function openQuiz() { alert("T√≠nh nƒÉng thi s·∫Ω d·ª±a tr√™n " + Object.keys(dictionary).length + " t·ª´ b·∫°n v·ª´a n·∫°p!"); }
    </script>
</body>
</html>
